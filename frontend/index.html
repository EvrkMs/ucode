<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ucode</title>
    
    <!-- Preconnect для Telegram CDN -->
    <link rel="preconnect" href="https://telegram.org" crossorigin>
    
    <!-- Inline критический CSS для первого рендера -->
    <style>
      :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --text: #0f172a;
        --border: #e2e8f0;
        --accent: #0f172a;
        font-family: system-ui, -apple-system, sans-serif;
      }
      
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0f172a;
          --card: #111827;
          --text: #e2e8f0;
          --border: #1f2937;
          --accent: #38bdf8;
        }
      }
      
      * { box-sizing: border-box; margin: 0; padding: 0; }
      
      body {
        margin: 0;
        color: var(--text);
        background: var(--bg);
        min-height: 100vh;
      }
      
      /* Inline loader - показывается сразу */
      #app-loader {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg);
        z-index: 9999;
      }
      
      #app-loader.hidden {
        display: none;
      }
      
      .loader-content {
        text-align: center;
        padding: 20px;
      }
      
      .spinner {
        width: 48px;
        height: 48px;
        margin: 0 auto 16px;
        border-radius: 50%;
        border: 4px solid var(--border);
        border-top-color: var(--accent);
        animation: spin 0.8s linear infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .loader-text {
        color: var(--text);
        font-size: 16px;
        margin-bottom: 8px;
      }
      
      .loader-subtext {
        color: var(--text);
        opacity: 0.6;
        font-size: 14px;
      }
      
      /* Скрываем root пока загружается */
      #root:empty {
        min-height: 100vh;
      }
    </style>
    
    <!-- Telegram WebApp SDK - async загрузка через наш домен (прокси) -->
    <script src="/telegram-web-app.js" async></script>
    
    <script>
      (function () {
        const endpoint = "/api/diag/client";
        const start = performance.now();
        const ua = navigator.userAgent;
        const send = (type, detail) => {
          const payload = JSON.stringify({ type, detail, ua, t: Math.round(performance.now() - start) });
          try {
            if (navigator.sendBeacon) {
              const blob = new Blob([payload], { type: "application/json" });
              navigator.sendBeacon(endpoint, blob);
              return;
            }
            fetch(endpoint, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: payload,
              keepalive: true
            }).catch(() => {});
          } catch {
            // ignore
          }
        };

        window.addEventListener("error", (e) => send("error", e.message || "script error"));
        window.addEventListener("unhandledrejection", (e) => send("unhandledrejection", String(e.reason)));

        // Убираем loader когда React отрендерится
        const checkRender = () => {
          const root = document.getElementById("root");
          if (root && root.hasChildNodes()) {
            const loader = document.getElementById("app-loader");
            if (loader) loader.classList.add("hidden");
          }
        };
        
        // Проверяем рендер каждые 100мс
        const renderInterval = setInterval(checkRender, 100);
        
        setTimeout(() => {
          clearInterval(renderInterval);
          if (!window.Telegram || !window.Telegram.WebApp) {
            send("no-telegram", "Telegram SDK not ready after 3s");
          }
          const root = document.getElementById("root");
          if (root && !root.hasChildNodes()) {
            send("render-wait", "Root empty after 3s");
            // Показываем ошибку если через 3 сек ничего не загрузилось
            const loaderText = document.querySelector(".loader-subtext");
            if (loaderText) {
              loaderText.textContent = "Медленное соединение... Пожалуйста, подождите";
              loaderText.style.color = "#ef4444";
            }
          }
        }, 3000);

        send("boot", "page-start");
      })();
    </script>
  </head>
  <body>
    <!-- Inline loader - показывается сразу -->
    <div id="app-loader">
      <div class="loader-content">
        <div class="spinner"></div>
        <div class="loader-text">Загрузка</div>
        <div class="loader-subtext">Подключение к серверу...</div>
      </div>
    </div>
    
    <div id="root"></div>
    <script type="module" src="/src/bootstrap.ts"></script>
  </body>
</html>
